<%- include ('header') -%>
<main style="padding-top: 100px;">
    <div class="container mt-5">
        <div class="row inform py-5">
            <div class="col-12 col-md-7 col-lg-7">
                <h3 class="mb-5">Contact Information</h3>
                <form method="POST" action="/checkouts"  id="payForm">
                    <%- include ('partials/messages') -%>
                    <h5 class="mb-2">Email Address</h5>
                    <div class="form-group">
                        <input required type="email" class="form-control" id="shippingAddressEmail">
                    </div>
                    <h5 class="mb-2">Shipping Address</h5>
                    <div class="d-flex justify-content-between">
                        <div class="form-group mr-1">
                            <input required type="text" class="form-control" id="firstName">
                        </div>
                        <div class="form-group ml-1">
                            <input required type="text" class="form-control" id="lastName">
                        </div>
                    </div>
                    <div class="form-group">
                        <input required type="text" class="form-control" value="" id="address" placeholder="Address">
                    </div>
                    <div class="form-group">
                        <input required type="text" class="form-control" value="" id="apartment" placeholder="Apartment">
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="form-group mr-1">
                            <input required type="text" class="form-control" value="" id="postalCode" placeholder="Postal Code">
                        </div>
                        <div class="form-group ml-1">
                            <input required type="text" class="form-control" value="" id="city" placeholder="City">
                        </div>
                    </div>
                    <div class="form-group">
                        <select required id="selectCountry" onchange="handleSelectChange()" name="country" class="form-control">
                            <option value="Country/Region" selected="selected">Country/Region</option>
                            <option value="Austria">Austria</option>
                            <option value="Austria">Austria</option>
                            <option value="Belgium">Belgium</option>
                            <option value="Bulgaria">Bulgaria</option>
                            <option value="Croatia"> Croatia</option>
                            <option value="Cyprus"> Cyprus</option>
                            <option value="Czech Republic"> Czech Republic</option>
                            <option value="Denmark">Denmark</option>
                            <option value="Estonia"> Estonia</option>
                            <option value="Finland">Finland</option>
                            <option value="France">France</option>
                            <option value="Germany">Germany</option>
                            <option value="Greece">Greece</option>
                            <option value="Hungary">Hungary</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Italy">Italy</option>
                            <option value="Latvia">Latvia</option>
                            <option value="Lithuania">Lithuania</option>
                            <option value="Luxembourg">Luxembourg</option>
                            <option value="Malta">Malta</option>
                            <option value="Lalov">Lalov</option>
                            <option value="Netherlands">Netherlands</option>
                            <option value="P Spain"> P Spain</option>
                            <option value="Sweden">Sweden</option>
                            <option value="Switzerland">Switzerland</option>
                            <option value="Serbia">Serbia</option>
                            <option value="Norway">Norway</option>
                            <option value="Bosnia and Herzegovina"> Bosnia and Herzegovina</option>
                            <option value="Albania">Albania</option>
                            <option value="Montenegro"> Montenegro</option>
                            <option value="Iceland">Iceland</option>
                            <option value="Andorra">Andorra</option>
                            <option value="Monaco">Monaco</option>
                            <option value="Vatican">Vatican</option>
                            <option value="Liechtenstein">Liechtenstein</option>
                            <option value="San Marino"> San Marino</option>
                            <option value="Macedonia">Macedonia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input required type="text" class="form-control" value="" id="phone" placeholder="Phone">
                    </div>
                    <input name="order" type="hidden" id="orderProducts">
                    <input name="shippingAddress" type="hidden" id="shippingAddress">
                    <button class="btn-green-gradient mb-3" style="height: 50px; width: 300px; border-radius:5px"
                            onclick="handleOrderAddress(this)">
                             Continue To Shipping
                    </button>
                </form>
            </div>
            <div class="col-12 col-md-5 col-lg-5 total-info">
                <div class="total-section" id='currentDiv'>
                    <hr>
                    <div class="d-flex">
                    </div>
                    <hr>
                    <div>
                        <div class="mb-3 d-flex justify-content-between">
                            <div>Sale</div>
                            <div id="salePrice"></div>
                        </div>
                        <div class="mb-3 d-flex justify-content-between">
                            <div>Delivery</div>
                            <div id="delivery">0</div>
                        </div>
                    </div>
                    <div class="mb-3 d-flex justify-content-between">
                        <h2 class="title"><b>TOTAL</b></h2>
                        <div class="product-price">
                            <h2 style="color: #065a1f"><b id="productPrice"></b></h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="js/jquery.js"></script>
<script src="js/bootstrap/bootstrap.min.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/script.js"></script>
<script>

    function handleSelectChange() {
        let totalPrice = document.getElementById('productPrice').innerHTML;
        totalPrice = Number(totalPrice.substring(0, totalPrice.length - 1));
        let country = document.getElementById("selectCountry").value;
        if (country !== 'Country/Region') {
            let priceDelivery = 0;
            let productsDeliveryFromArmeniaWeight = 0;
            let productsDeliveryFromSpainWeight = 0;
            const orderArray = JSON.parse(localStorage.getItem('order'));
            orderArray.forEach((item) => {
                if (item.registrationAddress === 'armenia') {
                    productsDeliveryFromArmeniaWeight += Number(item.productWeight);
                } else {
                    productsDeliveryFromSpainWeight += Number(item.productWeight);
                }
            });
            if (productsDeliveryFromArmeniaWeight && productsDeliveryFromArmeniaWeight <= 0.5) {
                priceDelivery += 19.5;
            } else if (productsDeliveryFromArmeniaWeight && productsDeliveryFromArmeniaWeight > 0.5 && productsDeliveryFromArmeniaWeight <= 1) {
                priceDelivery += 28.5;
            } else if (productsDeliveryFromArmeniaWeight > 1) {
                priceDelivery += Math.floor((productsDeliveryFromArmeniaWeight - 1) / 2) * 9 + 19.5;
            }

            if (country === 'P Spain') {
                if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 2) {
                    priceDelivery += 8.5;
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 2 && productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 5) {
                    priceDelivery += 9.5;
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 5) {
                    priceDelivery += Math.floor((productsDeliveryFromSpainWeight - 1) / 3) + 8.5;
                }
            } else if (country === 'USA  Canada') {
                if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 2) {
                    priceDelivery += 25.5;
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 2 && productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 5) {
                    priceDelivery += 50;//this must be changed
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 5) {
                    priceDelivery += Math.floor((productsDeliveryFromSpainWeight - 1) / 3) + 25.5;//this must be changed
                }
            } else {

                if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 2) {
                    priceDelivery += 11.5;
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 2 && productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight <= 5) {
                    priceDelivery += 25.5;//this must be changed
                } else if (productsDeliveryFromSpainWeight && productsDeliveryFromSpainWeight > 5) {
                    priceDelivery += Math.floor((productsDeliveryFromSpainWeight - 1) / 3) + 11.5;//this must be changed
                }
            }
            document.getElementById('delivery').innerHTML = `${priceDelivery}€`
            document.getElementById('productPrice').innerHTML = `${totalPrice + priceDelivery}€`
        } else {
            let totalDelivery = document.getElementById('delivery').innerHTML;
            totalDelivery = Number(totalDelivery.substring(0, totalDelivery.length - 1));
            document.getElementById('productPrice').innerHTML = `${totalPrice - totalDelivery}€`
            document.getElementById('delivery').innerHTML = `${0}€`
        }
    }

    function handleOrderAddress(element) {

        let address = document.getElementById('address');
        let apartment = document.getElementById('apartment');
        let postalCode = document.getElementById('postalCode');
        let city = document.getElementById('city');
        let country = $("#selectCountry").val();
        const phone = document.getElementById('phone');
            let totalDelivery = document.getElementById('delivery').innerHTML;
            totalDelivery = Number(totalDelivery.substring(0, totalDelivery.length - 1));
            const newObj = {
                address: address.value,
                apartment: apartment.value,
                postalCode: postalCode.value,
                city: city.value,
                country: country,
                deliveryPrice: totalDelivery,
                phone: phone.value,
            }
            const shippingAddress = JSON.stringify(newObj);
            localStorage.setItem('shippingAddress', shippingAddress);
            const order = localStorage.getItem('order');
            //shippingAddress
            document.getElementById('orderProducts').setAttribute('value',order);
            document.getElementById('shippingAddress').setAttribute('value',shippingAddress);
            //element.setAttribute('href', '/')
        // document.getElementById('payForm').setAttribute('action','/checkouts');
        // document.getElementById('payForm').setAttribute('method','/post');
    }

    window.onload = () => {
        const shippingAddressEmail = document.getElementById('shippingAddressEmail');
        const firstNameElement = document.getElementById('firstName');
        const lastNameElement = document.getElementById('lastName');
        const {firstName, lastName, email} = JSON.parse(localStorage.getItem('user'));
        shippingAddressEmail.setAttribute('placeholder', email);
        shippingAddressEmail.disabled = true;
        firstNameElement.setAttribute('placeholder', firstName);
        firstNameElement.disabled = true;
        lastNameElement.setAttribute('placeholder', lastName);
        lastNameElement.disabled = true;

        //==> this part i add in my window on load function
        let productTotalPrice = 0;
        let productSalePrice = 0;
        const salePrice = document.getElementById('salePrice');
        const productPrice = document.getElementById('productPrice');

        const order = JSON.parse(localStorage.getItem('order'));
        const shoppingCard = JSON.parse(localStorage.getItem('shoppingCard'));
        if (order && order.length) {
            order.forEach((item) => {
                let priceAfterSale = Number(item.priceSale.substring(0, item.priceSale.length - 1));
                let allPrice = Number(item.price.substring(0, item.price.length - 1));
                productTotalPrice += priceAfterSale;
                productSalePrice += allPrice;

                let div = document.createElement('div');
                currentDiv.prepend(div);
                div.setAttribute('class', 'd-flex');
                div.innerHTML = `
                        <div class="img-area">
                            <img src="${item.images}" alt="">
                            </div>
                        <div>
                            <h5>${item.name}</h5>
                            <div><span>${shoppingCard[shoppingCard.findIndex(x => x.productId == `${item.productId}`)].color}</span>/<span>${shoppingCard[shoppingCard.findIndex(x => x.productId == `${item.productId}`)].size}</span></div>
                        </div>
                        <div class="price ml-auto" style="text-decoration: line-through;">${item.price} </div>
                        <div class="price ml-auto">${item.priceSale} </div>
`
            })
            salePrice.innerHTML = `-${(productSalePrice - productTotalPrice).toFixed(1)}€`;
            productPrice.innerHTML = `${productTotalPrice}€`;
        }


        //clear shipping address when page is refresh
    }

</script>
<%- include ('footer') -%>
